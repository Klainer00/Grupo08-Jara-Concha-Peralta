name: CI/CD Pipeline Sumativa 3

on:
  push:
    branches: [ "main", "master" ]

env:
  # Estas variables son fijas y se usan en la autenticación
  REGION: us-central1
  PROJECT_ID: huerto-hogar-479801
  REPO_NAME: mi-repo
  REGISTRY_HOST: us-central1-docker.pkg.dev/huerto-hogar-479801/mi-repo

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    # 1. Bajar el código
    - name: Checkout code
      uses: actions/checkout@v3

    # 2. Autenticación con Google Cloud (Usa el Secreto de la llave)
    - name: Google Auth
      id: auth
      uses: 'google-github-actions/auth@v1'
      with:
        # 1. Reemplaza con el ID de tu proyecto de GCP
        project_id: ${{ env.PROJECT_ID }}
        # 2. Reemplaza con el nombre de tu Workload Identity Provider
        workload_identity_provider: 'projects/PROJECT_NUMBER/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
        # 3. Reemplaza con el email de la Cuenta de Servicio
        service_account: 'github-deployer@${{ env.PROJECT_ID }}.iam.gserviceaccount.com'

    # 3. Configurar Docker para GCR
    - name: Configure Docker
      run: |
        gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

    # 4. Construir y Subir Imágenes (Usando rutas fijas)
    - name: Build and Push Services
      run: |
        # Usamos la etiqueta :latest en todos los push para que sea consistente
        
        # --- USUARIOS ---
        docker build -t ${{ env.REGISTRY_HOST }}/usuarios:latest ./usuarios
        docker push ${{ env.REGISTRY_HOST }}/usuarios:latest
        
        # --- CARRITO ---
        docker build -t ${{ env.REGISTRY_HOST }}/carrito:latest ./carrito
        docker push ${{ env.REGISTRY_HOST }}/carrito:latest
        
        # --- CORE BACKEND ---
        docker build -t ${{ env.REGISTRY_HOST }}/core-backend:latest ./core
        docker push ${{ env.REGISTRY_HOST }}/core-backend:latest
        
        # --- API GATEWAY ---
        docker build -t ${{ env.REGISTRY_HOST }}/api-gateway:latest ./gateway
        docker push ${{ env.REGISTRY_HOST }}/api-gateway:latest

    # 5. Desplegar en Swarm vía SSH
    - name: Deploy to Swarm Manager
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          # Login explícito para refrescar credenciales en el Manager
          gcloud auth print-access-token | sudo docker login -u oauth2accesstoken --password-stdin https://${{ env.REGION }}-docker.pkg.dev
          
          # Actualizar servicios forzando la nueva imagen
          sudo docker service update --with-registry-auth --image ${{ env.REGISTRY_HOST }}/api-gateway:latest --force mi-app_gateway
          sudo docker service update --with-registry-auth --image ${{ env.REGISTRY_HOST }}/usuarios:latest --force mi-app_usuarios
          sudo docker service update --with-registry-auth --image ${{ env.REGISTRY_HOST }}/carrito:latest --force mi-app_carrito
          sudo docker service update --with-registry-auth --image ${{ env.REGISTRY_HOST }}/core-backend:latest --force mi-app_core-backend
